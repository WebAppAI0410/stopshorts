# Onboarding Flow E2E Test
# Tests the complete onboarding experience from welcome to start screen
#
# This flow uses demo mode skip for subsequent screens after user-setup
# because Android permissions require manual interaction with system settings.

appId: com.nverse.stopshorts
env:
  TEST_USER_NAME: "TestUser"
---
- launchApp:
    clearState: true

# Wait for Expo Dev Client to load
- waitForAnimationToEnd

# Handle iOS notification permission dialog
- runFlow:
    when:
      visible: "許可"
    commands:
      - tapOn: "許可"
      - waitForAnimationToEnd

# Connect to Metro bundler (Expo Dev Client)
- runFlow:
    when:
      visible: "http://localhost:8081"
    commands:
      - tapOn: "http://localhost:8081"
      - waitForAnimationToEnd:
          timeout: 10000

# Handle Expo Dev Menu Continue button
- runFlow:
    when:
      visible: "Continue"
    commands:
      - tapOn: "Continue"
      - waitForAnimationToEnd

# Handle Expo Dev Menu Close button
- runFlow:
    when:
      visible: "Close"
    commands:
      - tapOn: "Close"
      - waitForAnimationToEnd

# Wait for app to fully load after connecting to Metro
- waitForAnimationToEnd:
    timeout: 5000

# ============================================
# Screen 1: Welcome Screen
# ============================================
- assertVisible:
    id: "onboarding-welcome-screen"
- assertVisible: "ショート動画を、やめる。"
- assertVisible: "始める"

# Tap start button using testID for reliability
- tapOn:
    id: "onboarding-start-button"

- waitForAnimationToEnd

# ============================================
# Screen 2: User Setup - Name Input
# ============================================
- assertVisible: "はじめまして"
- assertVisible: "お名前を教えてください"

# Input user name
- tapOn:
    text: "ニックネーム"
- inputText: ${TEST_USER_NAME}
- hideKeyboard

# Tap "次へ" button using testID (fixes coordinate-based tap issue)
- tapOn:
    id: "next-button"

- waitForAnimationToEnd:
    timeout: 3000

# ============================================
# Screen 2b: User Setup - Permission Step (Android only)
# ============================================
# Note: We verify the permission screen appears but use demo mode
# because Android permissions require manual system settings interaction
- runFlow:
    when:
      visible: "使用状況へのアクセスを許可"
    commands:
      - assertVisible: "使用状況へのアクセスを許可"
      # Screenshot for verification
      - takeScreenshot: "permission_screen"
      # Since we can't automate Android system settings,
      # restart and use demo mode for the rest of the flow
      - launchApp:
          clearState: true
      - waitForAnimationToEnd
      - tapOn:
          text: ".*デモモードでスキップ.*"
      - waitForAnimationToEnd:
          timeout: 3000

# ============================================
# Verify we're on the main dashboard after demo skip
# ============================================
- waitForAnimationToEnd:
    timeout: 3000

# Dashboard should be visible
- assertVisible:
    text: ".*ダッシュボード.*|.*今日.*|.*設定.*"
    optional: true

# Take final screenshot
- takeScreenshot: "onboarding_complete"
