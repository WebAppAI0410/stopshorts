# Training Module E2E Test
# Tests navigating through training topics, articles, quizzes, and worksheets
#
# Prerequisites: None - uses demo mode skip if onboarding is shown

appId: com.nverse.stopshorts
---
- launchApp:
    clearState: true

# Wait for app to fully load
- waitForAnimationToEnd

# Handle iOS notification permission dialog
- runFlow:
    when:
      visible: "許可"
    commands:
      - tapOn: "許可"
      - waitForAnimationToEnd

# Handle Expo Dev Client dialogs
- runFlow:
    when:
      visible: "http://localhost:8081"
    commands:
      - tapOn: "http://localhost:8081"
      - waitForAnimationToEnd:
          timeout: 10000

- runFlow:
    when:
      visible: "Continue"
    commands:
      - tapOn: "Continue"
      - waitForAnimationToEnd

- runFlow:
    when:
      visible: "Close"
    commands:
      - tapOn: "Close"
      - waitForAnimationToEnd

# ============================================
# Skip onboarding using demo mode
# ============================================
- runFlow:
    when:
      visible: "始める"
    commands:
      - waitForAnimationToEnd
      - tapOn:
          text: ".*デモモードでスキップ.*"
      - waitForAnimationToEnd:
          timeout: 3000

# ============================================
# Navigate to Training Tab
# ============================================
- waitForAnimationToEnd:
    timeout: 3000

# Tap on training tab - use regex to handle potential i18n issues
- tapOn:
    text: ".*トレーニング.*|.*training.*|.*学習.*"

- waitForAnimationToEnd

# ============================================
# Verify Training Screen
# ============================================
- assertVisible: "トレーニング"
- assertVisible: "科学的アプローチ"

# Take screenshot of training list
- takeScreenshot: "training_list"

# ============================================
# Open a Training Topic
# ============================================
- scrollUntilVisible:
    element: "習慣ループを理解する"
    direction: DOWN
    timeout: 10000

- tapOn: "習慣ループを理解する"
- waitForAnimationToEnd

# ============================================
# Verify Topic Detail Screen
# ============================================
- assertVisible: "記事"
- assertVisible: "クイズ"
- assertVisible: "ワークシート"

# Take screenshot of topic detail
- takeScreenshot: "topic_detail"

# ============================================
# Article Phase
# ============================================
- tapOn: "記事"
- waitForAnimationToEnd

- assertVisible: "習慣の3つの要素"

# Scroll through article content
- scrollUntilVisible:
    element: "次へ進む"
    direction: DOWN
    timeout: 15000
    speed: 40

- tapOn: "次へ進む"
- waitForAnimationToEnd

# ============================================
# Quiz Phase
# ============================================
- assertVisible: "クイズ"
- assertVisible: "習慣ループの理解度チェック"

# Answer first question - scroll to ensure visibility
- scrollUntilVisible:
    element: "きっかけ・ルーティン・報酬"
    direction: DOWN
    timeout: 10000

- tapOn: "きっかけ・ルーティン・報酬"
- waitForAnimationToEnd

# Answer second question - scroll to ensure visibility
- scrollUntilVisible:
    element: "ルーティンを別の行動に置き換える"
    direction: DOWN
    timeout: 10000

- tapOn: "ルーティンを別の行動に置き換える"
- waitForAnimationToEnd

# Check answers
- scrollUntilVisible:
    element: "答え合わせ"
    direction: DOWN
    timeout: 10000

- tapOn: "答え合わせ"
- waitForAnimationToEnd

# Take screenshot of quiz results
- takeScreenshot: "quiz_results"

# Continue to worksheet
- scrollUntilVisible:
    element: "次へ進む"
    direction: DOWN
    timeout: 10000

- tapOn: "次へ進む"
- waitForAnimationToEnd

# ============================================
# Worksheet Phase
# ============================================
- assertVisible: "ワークシート"
- assertVisible: "あなたの習慣ループを分析しよう"

# Find and tap on input field
- scrollUntilVisible:
    element: ".*きっかけを書いてください.*"
    direction: DOWN
    timeout: 10000

- tapOn:
    text: ".*きっかけを書いてください.*"

# Note: Maestro doesn't fully support Japanese input, use ASCII text
- inputText: "Bored at home scrolling"
- hideKeyboard

# Save response
- scrollUntilVisible:
    element: "回答を保存"
    direction: DOWN
    timeout: 10000

- tapOn: "回答を保存"
- waitForAnimationToEnd

# ============================================
# Complete Phase
# ============================================
- assertVisible:
    text: ".*トピック完了.*|.*完了.*"

# Take screenshot of completion
- takeScreenshot: "topic_complete"

# Return to topic list
- tapOn: "トピック一覧に戻る"
- waitForAnimationToEnd

# ============================================
# Verify return to Training List
# ============================================
- assertVisible: "科学的アプローチ"

# Final screenshot
- takeScreenshot: "training_flow_complete"
