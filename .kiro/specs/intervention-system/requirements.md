# 介入システム拡張 - 要求仕様書

## 概要

StopShortsアプリの介入機能を拡張し、心理学的根拠に基づいた複数の介入方法を提供する。ユーザーが自分に最適な介入方法を選択できるようにし、AIチャットボットと心理トレーニングで長期的な行動変容を支援する。

## 背景

### 現状の課題
- 現在は「衝動サーフィング（呼吸）」のみ
- ユーザーの好みや状況に応じた選択肢がない
- 根本的な原因への内省支援がない
- 心理学的知識の学習機会がない

### 心理学的根拠
- **フリクション/ナッジ理論**: 待機時間による即時満足の遮断
- **実装意図 (Implementation Intentions)**: If-Then計画による自動的行動変容
- **自己対峙**: ミラーを見ることによる自己認識の向上
- **認知行動療法**: 対話による認知の再構築

---

## 機能要件

### REQ-1: フリクション/ナッジ介入 ✅

#### REQ-1.1: 累積待機時間 ✅
- [x] 同日内でアプリを開こうとするたびに待機時間が増加する
- [x] 増加パターン: 指数的（5秒→8秒→13秒→21秒→34秒→55秒→89秒）
- [x] 毎日午前0時にリセットされる (`shouldResetDailyCount()`)
- [x] 待機中はカウントダウンを表示する (`WaitingPhase.tsx`)

#### REQ-1.2: 意図入力 ✅
- [x] 待機後、「何をしに行きますか？」と意図を確認する
- [x] 選択肢を提供（DMを確認、特定のコンテンツを見る、暇つぶし、なんとなく）
- [x] 「その他」で自由入力も可能
- [x] 入力された意図は統計データとして記録する (`recordIntention()`)

> **Note**: この意図入力はフリクション介入における「今、何をしようとしているか」の確認であり、REQ-3.2のIf-Then計画（実装意図）とは異なる。If-Then計画は「もし〜なら、〜する」という事前の行動計画であり、オンボーディングで設定する長期的な戦略。意図入力は介入発動時のその場での内省促進が目的。

#### REQ-1.3: エラーハンドリング（部分実装）
- [ ] タイマー中にアプリがバックグラウンドに移行した場合、フォアグラウンド復帰時にタイマーを再開する（経過時間は保持）
  - ⚠️ 未実装：Phase 6で対応予定
- [ ] ネットワーク接続がない状態でダウンロードを試行した場合、「インターネット接続を確認してください」とエラー表示する
  - ⚠️ 未実装：Phase 5 (AI) で対応予定
- [x] 日付変更（午前0時）時に待機時間をリセットする処理を確実に実行する
  - [x] アプリがバックグラウンドの場合も、次回起動時にリセット判定を行う
  - [ ] タイムゾーン変更にも対応する（未テスト）

### REQ-2: ミラー介入

#### REQ-2.1: 前面カメラ表示
- [ ] 前面カメラを起動し、ユーザーの顔を表示する
- [ ] カメラ映像の上に目標テキストをオーバーレイ表示する
- [ ] 目標はオンボーディングで設定したものを使用する

#### REQ-2.2: 内省時間
- [ ] 一定時間（10-20秒）自分を見つめる時間を設ける
- [ ] 「本当に開きたいですか？」の確認を含める
- [ ] 終了後に「開く」「やめる」の選択を提示

#### REQ-2.3: カメラ権限処理
- [ ] カメラ権限が拒否された場合、代替介入（呼吸またはフリクション）に自動フォールバックする
- [ ] 設定画面からカメラ権限の再設定を案内する（OSの設定画面へのディープリンク）
- [ ] 権限を後から取り消された場合も、次回ミラー介入時に検知してフォールバックする
- [ ] 権限状態の変化をリアルタイムで監視し、利用可能になったら通知する（オプション）

### REQ-3: 介入方法の選択システム

#### REQ-3.1: 選択肢の管理
- [ ] 現時点の選択肢: 呼吸（衝動サーフィング）、フリクション、ミラー
- [ ] 将来の拡張に対応できる設計にする
- [ ] ユーザーが設定画面で介入方法を変更できる

#### REQ-3.2: オンボーディングでの選択
- [ ] 現在のIf-Thenステップを介入方法選択に置き換える
- [ ] 「あなたはショート動画アプリを開こうとしています。どんな方法で止めるのが効果的ですか？」形式で提示
- [ ] 選んだ方法をフルで体験させる
- [ ] 他の方法も任意で体験可能（「他も試す」ボタン）

> **Note**: ここでの「介入方法選択」は「開こうとしたときにどう止めるか」の戦略選択。REQ-1.2の意図入力とは異なり、事前に設定する長期的な行動計画である。If-Then計画（実装意図）のフレームワークに基づき、「もしショート動画を開こうとしたら、[選択した介入方法]を実行する」という形で設定される。

### REQ-4: AIチャットボット

#### REQ-4.1: アクセス方法
- [ ] **専用タブ**: ボトムナビゲーションに「AI」タブを追加
- [ ] **介入中**: Shield画面で呼吸・フリクション・ミラーに加え「AIと話す」を選択可能

#### REQ-4.2: 会話開始トリガー
- [ ] **ユーザー主導**: AIタブをタップして開始
- [ ] **AI提案**: 特定条件で通知
  - 連続して開こうとした場合（例: 1時間に3回以上）
  - 長時間ブロックに成功した後（励まし）
  - 新しいトレーニングコンテンツ利用可能時
- [ ] **毎日のチェックイン**: 1日1回、振り返り提案通知（オプトイン）

#### REQ-4.3: 会話モード
- [ ] **基本**: 自由チャット（何でも話せる）
- [ ] **クイックアクション**: タップで特定モードを開始
  - 「原因を探る」: なぜ開いてしまうのか深掘り
  - 「If-Thenプランを作成」: 実装意図の作成支援
  - 「トレーニングを受ける」: 心理トレーニングへの誘導
  - 「今日を振り返る」: デイリーリフレクション

#### REQ-4.4: データ参照と言及
- [ ] **積極的に言及**: ユーザーデータを会話に組み込む
  - 「今日は5回開こうとしたね。何かあった？」
  - 「先週より20%減ってるよ！すごい！」
  - 「目標の『睡眠改善』に向けて、夜の使用が減ってるね」
- [ ] 参照データ:
  - 統計データ（開いた回数、成功率、トレンド）
  - 目標・設定（なぜ減らしたいか）
  - 過去の対話履歴（コンテキスト継続）
  - トレーニング進捗

#### REQ-4.5: パーソナリティ設定
- [ ] オンボーディング時に好みを設定
- [ ] 設定画面でいつでも変更可能
- [ ] バリエーション:
  - ポジティブ/励まし型
  - ストレート/厳しめ型
  - その他のトーン（要調査）

#### REQ-4.6: メンタルヘルス対応
- [ ] **緩和ケア方針**: 危機的表現を検知した場合
  - 共感的に傾聴する
  - 「つらいんだね」「話してくれてありがとう」
  - 専門家への相談を優しく提案（強制しない）
  - 相談窓口の情報を提供（いのちの電話等）
- [ ] ショート動画依存以外の深刻な悩みには適切に境界を設ける

#### REQ-4.7: 技術実装
- [ ] **採用モデル**: Gemma 3n E2B（2GB RAM、60-70 tokens/秒）
- [ ] **統合方法**: react-native-executorch を使用
- [ ] クラウドAPIへのフォールバックは行わない
- [ ] **履歴管理**: コンテキストエンジニアリング（別途リポジトリ参照）

#### REQ-4.8: モデルダウンロード
- [ ] **トリガー**: AIタブに初めてアクセスした時にダウンロード提案
- [ ] オンボーディング後の機能紹介フローがあれば、そこで自然に案内
- [ ] ダウンロード前にデバイス互換性をチェック（RAM ≥ 2GB、空きストレージ ≥ 2GB）
- [ ] ダウンロードは任意（「後で」選択可能）
- [ ] Wi-Fi接続時のみダウンロードを推奨
- [ ] バックグラウンドダウンロード対応
- [ ] 進捗表示（パーセンテージ）

#### REQ-4.9: 非対応デバイス
- [ ] 互換性チェック不合格時はAIタブを非表示（または無効化）
- [ ] 設定画面で「お使いのデバイスではAI機能を利用できません」と表示
- [ ] 他の機能（介入、トレーニング、統計）は通常通り利用可能

#### REQ-4.10: コンテキストエンジニアリング（履歴管理）
**詳細設計**: [context-engineering.md](./context-engineering.md)

- [ ] **3層メモリシステム**:
  - 短期（Working）: 現在のセッション会話
  - 中期（Session）: 過去セッションの要約（最大10件）
  - 長期（Persistent）: ユーザーの洞察・パターン
- [ ] **Append-Only原則**: 履歴は追加のみ、編集・削除しない
- [ ] **圧縮戦略**: トークン上限（~2500）を超えたら古いメッセージを要約に置換
- [ ] **セッション終了時**: LLMで会話を要約し、洞察を抽出して保存
- [ ] **トークン予算**: システムプロンプト500 + ユーザーコンテキスト300 + 履歴2500 + バッファ500

#### REQ-4.11: アプリアップデート互換性
- [ ] **スキーマバージョニング**: 全ストレージデータにバージョン番号を付与
- [ ] **マイグレーション**: アプリ起動時に自動実行
- [ ] **後方互換性**:
  - フィールド追加: デフォルト値でマイグレーション
  - フィールド削除: 古いデータは無視（削除しない）
  - 型変更: 変換関数でマイグレーション
- [ ] **システムプロンプトバージョン**: 古いセッション再開時も同じプロンプトを使用

### REQ-5: 心理トレーニング

#### REQ-5.1: コンテンツ形式
- [ ] 読み物（記事形式）: 研究結果、心理学的知識
- [ ] クイズ形式: 理解度確認
- [ ] ワークシート形式: 自分の状況への適用

#### REQ-5.2: トピック構成
- [ ] 研究ベース（メイン）:
  - 習慣ループ（キュー→ルーティン→報酬）
  - 実装意図（If-Then計画）
  - マインドフルネスと衝動サーフィング
  - 遅延報酬と前頭前皮質
  - 認知的再評価
- [ ] 情緒ベース:
  - 退屈への対処
  - 不安・孤独感への対処
- [ ] 目標ベース:
  - 睡眠改善との関連
  - 集中力向上との関連
  - 生産性向上との関連

#### REQ-5.3: 進行方式
- [ ] トピック別選択（線形カリキュラムではない）
- [ ] 1日1回推奨ペース
- [ ] まとめて受講も可能
- [ ] ダッシュボードから常時アクセス可能

### REQ-6: 課金・オンボーディング

#### REQ-6.1: 課金モデル
- [ ] 全機能は有料プランに含まれる
- [ ] 無料体験期間中も全機能使用可能

#### REQ-6.2: 課金前のプレビュー
- [ ] 課金の意思決定直前にAI・トレーニングのモックアップを表示
- [ ] 「こんな機能があります」と価値を伝える

---

## 非機能要件

### NFR-1: パフォーマンス
- [ ] 介入画面は500ms以内に表示
- [ ] カメラ起動は1秒以内
- [ ] ローカルLLMの応答は3秒以内

### NFR-2: プライバシー
- [ ] カメラ映像は端末内でのみ処理、保存しない
- [ ] AI対話ログは端末内に保存、外部送信しない

### NFR-3: アクセシビリティ
- [ ] 介入方法の説明はスクリーンリーダー対応
- [ ] カメラを使えないユーザーへの代替手段

### NFR-4: 多言語対応 (i18n)
- [ ] 全ての新規UI文字列は `src/i18n/locales/ja.json` に追加
- [ ] 介入関連のi18nキー構造:
  - `intervention.friction.*` - フリクション介入
  - `intervention.mirror.*` - ミラー介入
  - `intervention.selection.*` - 介入選択
  - `intervention.ai.*` - AIチャット
  - `training.*` - 心理トレーニング
- [ ] ハードコードされた日本語テキストは禁止
- [ ] 将来の多言語展開に備えた設計

### NFR-5: プラットフォーム対応
- [ ] Android優先実装（デバッグ容易性のため）
- [ ] iOS実装はAndroid検証後に実施
- [ ] プラットフォーム固有コードは明確に分離
- [ ] `Platform.OS` による分岐は最小限に

### NFR-6: セキュリティ
- [ ] AI会話履歴は端末内で暗号化して保存する
- [ ] 機密データの保存には `expo-secure-store` を使用する（AsyncStorageの代替として検討）
- [ ] iCloud/Googleバックアップからの除外オプションを提供する
- [ ] データエクスポート機能を提供する（ユーザーが自分のデータを取得可能）
- [ ] 完全削除機能を提供する（アカウント削除時に全データを消去）
- [ ] センシティブデータ（AI会話、統計）へのアクセスにはアプリロック（生体認証/PIN）をオプションで設定可能

### NFR-7: 可用性
- [ ] オフライン時もAI以外の全機能が完全動作することを保証する
  - 介入（呼吸、フリクション、ミラー）はオフラインで動作
  - 統計表示はローカルデータで動作
  - トレーニングコンテンツはプリロードで動作
- [ ] LLMモデル読み込み失敗時のgraceful degradation
  - AIタブでエラーメッセージを表示
  - 再ダウンロードオプションを提供
  - 他の介入方法への誘導を行う
- [ ] ストレージ不足時のモデルダウンロード失敗ハンドリング

---

## 優先順位

1. **P0 (MVP)**: フリクション/ナッジ介入
2. **P1**: ミラー介入
3. **P1**: 介入方法選択システム + オンボーディング更新
4. **P2**: 心理トレーニング
5. **P2**: AIチャットボット

---

## 用語集

| 用語 | 定義 |
|------|------|
| フリクション | 行動を起こしにくくする摩擦・障壁 |
| ナッジ | 強制ではなく選択を誘導する設計 |
| 実装意図 | 「もしXなら、Yする」形式の事前計画 |
| 衝動サーフィング | 衝動を波として観察し、やり過ごす技法 |
| 認知的再評価 | 状況の解釈を変えて感情反応を調整する技法 |
