name: CI

on:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 18 * * *'

jobs:
  lint-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run typecheck
      - run: npm test -- --runInBand

  e2e-android:
    runs-on: ubuntu-latest
    needs: lint-typecheck
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - run: npm ci
      - uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - name: Trigger EAS Android build
        run: |
          BUILD_JSON=$(eas build --platform android --profile detox-android --non-interactive --json)
          echo "$BUILD_JSON" > /tmp/eas-android-build.json
          BUILD_ID=$(node -e "const data=require('/tmp/eas-android-build.json'); console.log(data[0].id);")
          echo "EAS_ANDROID_BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
      - name: Generate Android fingerprint
        run: |
          eas fingerprint:generate --json --non-interactive --platform android --build-profile detox-android > /tmp/eas-android-fingerprint.json
          FINGERPRINT=$(node -e "const fs=require('fs');const raw=fs.readFileSync('/tmp/eas-android-fingerprint.json','utf8');const start=raw.indexOf('{');const end=raw.lastIndexOf('}');const data=JSON.parse(raw.slice(start,end+1));console.log(data.hash);")
          echo "EAS_ANDROID_FINGERPRINT=$FINGERPRINT" >> $GITHUB_ENV
      - name: Download Android build
        run: |
          mkdir -p artifacts/android
          eas build:download --platform android --fingerprint $EAS_ANDROID_FINGERPRINT --non-interactive --json > /tmp/eas-android-download.json
          APK_PATH=$(node -e "const fs=require('fs');const raw=fs.readFileSync('/tmp/eas-android-download.json','utf8');const start=raw.indexOf('{');const end=raw.lastIndexOf('}');const data=JSON.parse(raw.slice(start,end+1));console.log(data.path||data.filePath||data.artifactPath||data.localFilePath||'');")
          APK_PATH=$(echo "$APK_PATH" | sed -e 's/^\"//' -e 's/\"$//')
          if [ -z \"$APK_PATH\" ]; then
            APK_PATH=$(find . -maxdepth 3 -name \"*.apk\" -type f | head -n 1)
          fi
          if [ -z \"$APK_PATH\" ]; then
            echo \"No APK found after download.\" >&2
            exit 1
          fi
          mv $APK_PATH artifacts/android/app-debug.apk
      - name: Prebuild Android native project
        run: npx expo prebuild --platform android --no-install --clean
      - name: Build Detox test APK
        run: cd android && ./gradlew assembleAndroidTest -DtestBuildType=debug
      - name: Run Detox on Android emulator
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          avd-name: detox
          force-avd-creation: true
          disable-animations: true
          script: |
            export DETOX_ANDROID_BINARY_PATH=$GITHUB_WORKSPACE/artifacts/android/app-debug.apk
            export DETOX_ANDROID_TEST_BINARY_PATH=$GITHUB_WORKSPACE/android/app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk
            npm run e2e:test:android

  e2e-ios:
    runs-on: macos-latest
    needs: lint-typecheck
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - name: Trigger EAS iOS simulator build
        run: |
          set +e
          BUILD_JSON=$(eas build --platform ios --profile detox-ios --non-interactive --json)
          BUILD_STATUS=$?
          echo "$BUILD_JSON" > /tmp/eas-ios-build.json
          BUILD_ID=$(node -e "const data=require('/tmp/eas-ios-build.json'); console.log(data[0].id);")
          echo "EAS_IOS_BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "EAS_IOS_BUILD_EXIT=$BUILD_STATUS" >> $GITHUB_ENV
          exit 0
      - name: Inspect iOS build on failure
        if: ${{ env.EAS_IOS_BUILD_EXIT != '0' }}
        run: |
          eas build:view $EAS_IOS_BUILD_ID --json || true
      - name: Fail if iOS build failed
        if: ${{ env.EAS_IOS_BUILD_EXIT != '0' }}
        run: exit 1
      - name: Generate iOS fingerprint
        run: |
          eas fingerprint:generate --json --non-interactive --platform ios --build-profile detox-ios > /tmp/eas-ios-fingerprint.json
          FINGERPRINT=$(node -e "const fs=require('fs');const raw=fs.readFileSync('/tmp/eas-ios-fingerprint.json','utf8');const start=raw.indexOf('{');const end=raw.lastIndexOf('}');const data=JSON.parse(raw.slice(start,end+1));console.log(data.hash);")
          echo "EAS_IOS_FINGERPRINT=$FINGERPRINT" >> $GITHUB_ENV
      - name: Download iOS build
        run: |
          mkdir -p artifacts/ios
          eas build:download --platform ios --fingerprint $EAS_IOS_FINGERPRINT --non-interactive --json > /tmp/eas-ios-download.json
          ARCHIVE_PATH=$(node -e "const fs=require('fs');const raw=fs.readFileSync('/tmp/eas-ios-download.json','utf8');const start=raw.indexOf('{');const end=raw.lastIndexOf('}');const data=JSON.parse(raw.slice(start,end+1));console.log(data.path||data.filePath||data.artifactPath||data.localFilePath||'');")
          ARCHIVE_PATH=$(echo "$ARCHIVE_PATH" | sed -e 's/^\"//' -e 's/\"$//')
          if [ -z \"$ARCHIVE_PATH\" ]; then
            ARCHIVE_PATH=$(find . -maxdepth 3 -name \"*.tar.gz\" -type f | head -n 1)
          fi
          if [ -z \"$ARCHIVE_PATH\" ]; then
            echo \"No iOS archive found after download.\" >&2
            exit 1
          fi
          mv $ARCHIVE_PATH artifacts/ios/ios-build.tar.gz
      - name: Extract iOS app
        run: |
          mkdir -p artifacts/ios/app
          if ! tar -xzf artifacts/ios/ios-build.tar.gz -C artifacts/ios/app; then
            unzip -q artifacts/ios/ios-build.tar.gz -d artifacts/ios/app
          fi
          APP_PATH=$(find artifacts/ios/app -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "No .app found after extracting iOS build." >&2
            exit 1
          fi
          echo "DETOX_IOS_BINARY_PATH=$GITHUB_WORKSPACE/$APP_PATH" >> $GITHUB_ENV
      - name: Run Detox on iOS simulator
        run: npm run e2e:test:ios
        env:
          DETOX_IOS_BINARY_PATH: ${{ env.DETOX_IOS_BINARY_PATH }}
