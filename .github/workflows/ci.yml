name: CI

on:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 18 * * *'

jobs:
  lint-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run typecheck

  e2e-android:
    runs-on: ubuntu-latest
    needs: lint-typecheck
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - run: npm ci
      - uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - name: Trigger EAS Android build
        run: |
          BUILD_JSON=$(eas build --platform android --profile detox-android --non-interactive --json)
          echo "$BUILD_JSON" > /tmp/eas-android-build.json
          BUILD_ID=$(node -e "const data=require('/tmp/eas-android-build.json'); console.log(data[0].id);")
          echo "EAS_ANDROID_BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
      - name: Download Android build
        run: |
          mkdir -p artifacts/android
          eas build:download --platform android --id $EAS_ANDROID_BUILD_ID --path artifacts/android/app-debug.apk
      - name: Build Detox test APK
        run: cd android && ./gradlew assembleAndroidTest -DtestBuildType=debug
      - name: Run Detox on Android emulator
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          avd-name: detox
          force-avd-creation: true
          disable-animations: true
          script: |
            export DETOX_ANDROID_BINARY_PATH=$GITHUB_WORKSPACE/artifacts/android/app-debug.apk
            export DETOX_ANDROID_TEST_BINARY_PATH=$GITHUB_WORKSPACE/android/app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk
            npm run e2e:test:android

  e2e-ios:
    runs-on: macos-latest
    needs: lint-typecheck
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - name: Trigger EAS iOS simulator build
        run: |
          BUILD_JSON=$(eas build --platform ios --profile detox-ios --non-interactive --json)
          echo "$BUILD_JSON" > /tmp/eas-ios-build.json
          BUILD_ID=$(node -e "const data=require('/tmp/eas-ios-build.json'); console.log(data[0].id);")
          echo "EAS_IOS_BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
      - name: Download iOS build
        run: |
          mkdir -p artifacts/ios
          eas build:download --platform ios --id $EAS_IOS_BUILD_ID --path artifacts/ios/ios-build.tar.gz
      - name: Extract iOS app
        run: |
          mkdir -p artifacts/ios/app
          if ! tar -xzf artifacts/ios/ios-build.tar.gz -C artifacts/ios/app; then
            unzip -q artifacts/ios/ios-build.tar.gz -d artifacts/ios/app
          fi
          APP_PATH=$(find artifacts/ios/app -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "No .app found after extracting iOS build." >&2
            exit 1
          fi
          echo "DETOX_IOS_BINARY_PATH=$GITHUB_WORKSPACE/$APP_PATH" >> $GITHUB_ENV
      - name: Run Detox on iOS simulator
        run: npm run e2e:test:ios
        env:
          DETOX_IOS_BINARY_PATH: ${{ env.DETOX_IOS_BINARY_PATH }}
